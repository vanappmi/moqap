include:
  - project: "moqap/modules"
    ref: "3.3.2"
    file: "/trivy/trivy.yml"

.job_template: &job_template
  tags:
    - $PROJECT_RUNNER_TAG

Trivy Check Image:
  extends: .Trivy Scan
  stage: static-codeanalysis
  needs:
    - job: Artifacts STAGE
  <<: *job_template
  rules:
    - if: $CI_COMMIT_BRANCH && ($DEPLOY_ENV == "dev" || $DEPLOY_ENV == "int")
      allow_failure: true
    - if: $CI_COMMIT_BRANCH && ($DEPLOY_ENV  == "au" || $DEPLOY_ENV  == "prod")
      when: manual
      allow_failure: true
    - if: '$DEPLOY_ENV != "dev" && $DEPLOY_ENV  != "int"'
  variables:
    TRIVY_ADD_CMD: "--no-progress --timeout 30m --offline-scan --debug --scanners vuln"

Trivy Check Repo:
  extends: .Trivy Scan
  stage: static-codeanalysis
  needs:
    - job: Artifacts STAGE
  <<: *job_template
  rules:
    - if: $CI_COMMIT_BRANCH && ($DEPLOY_ENV == "dev" || $DEPLOY_ENV  == "int")
  variables:
    TRIVY_TARGET: "$CI_PROJECT_DIR"
    TRIVY_SCAN_CMD: "filesystem"
  allow_failure: true
  
