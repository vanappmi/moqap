---
include:
  - "/pipelines/settings.yaml"

variables:
  PROJECT_RUNNER_TAG: "eks-entwicklung"
  DEPLOY_ENV: "dev"
  CI_REGISTRY: "${DEV_DOCKER_REPO}.bahnhub.tech.rz.db.de"
  KANIKO_IMAGE_TAG: $CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA
  TRIVY_TARGET: "$CI_REGISTRY/$CI_PROJECT_NAME:$KANIKO_IMAGE_TAG"
  SOURCE_DOCKER_REPO: ${DEV_DOCKER_REPO}
  TARGET_DOCKER_REPO: ${PROD_DOCKER_REPO}
  ARTIFACT_NAME: $CI_PROJECT_NAME

Scan Pipeline STAGE Image:
  stage: security-scan
  variables:
    TRIVY_TARGET: "cna-bbpneo-prod-docker-stage-local.bahnhub.tech.rz.db.de/basis-pipeline-image:version-3"
  trigger:
    include:
      - project: "cnp/bbpneo/02-ops/moqap" # dbds moqap project
        ref: "$CURRENT_VERSION" # branch
        file: "pipelines/trivy/trivy-scanimage.yaml"
    strategy: depend

#Scan Service Deployment Image (Java19):
#  stage: security-scan
#  variables:
#    TRIVY_TARGET: "cna-bbpneo-dev-docker-stage-local.bahnhub.tech.rz.db.de/basis-deployment-image:java-19"
#  trigger:
#    include:
#      - project: "cnp/bbpneo/02-ops/moqap" # dbds moqap project
#        ref: "$CURRENT_VERSION" # branch
#        file: "pipelines/trivy/trivy-scanimage.yaml"
#    strategy: depend

Scan Service Deployment Image (Java21):
  stage: security-scan
  variables:
    TRIVY_TARGET: "cna-bbpneo-prod-docker-stage-local.bahnhub.tech.rz.db.de/basis-deployment-image:java-21"
  trigger:
    include:
      - project: "cnp/bbpneo/02-ops/moqap" # dbds moqap project
        ref: "$CURRENT_VERSION" # branch
        file: "pipelines/trivy/trivy-scanimage.yaml"
    strategy: depend

Scan Amazon Coretto 18-alpine base:
  stage: security-scan
  variables:
    TRIVY_TARGET: "docker-hub-remote.bahnhub.tech.rz.db.de/amazoncorretto:18-alpine"
  trigger:
    include:
      - project: "cnp/bbpneo/02-ops/moqap" # dbds moqap project
        ref: "$CURRENT_VERSION" # branch
        file: "pipelines/trivy/trivy-scanimage.yaml"
    strategy: depend

Scan Amazon Coretto 19-alpine base:
  stage: security-scan
  variables:
    TRIVY_TARGET: "docker-hub-remote.bahnhub.tech.rz.db.de/amazoncorretto:19-alpine"
  trigger:
    include:
      - project: "cnp/bbpneo/02-ops/moqap" # dbds moqap project
        ref: "$CURRENT_VERSION" # branch
        file: "pipelines/trivy/trivy-scanimage.yaml"
    strategy: depend

Scan Amazon Coretto 21-alpine base:
  stage: security-scan
  variables:
    TRIVY_TARGET: "docker-hub-remote.bahnhub.tech.rz.db.de/amazoncorretto:21-alpine"
  trigger:
    include:
      - project: "cnp/bbpneo/02-ops/moqap" # dbds moqap project
        ref: "$CURRENT_VERSION" # branch
        file: "pipelines/trivy/trivy-scanimage.yaml"
    strategy: depend

Scan AWS Client Image:
  stage: security-scan
  variables:
    TRIVY_TARGET: "docker-hub-remote.bahnhub.tech.rz.db.de/amazon/aws-cli:latest"
  trigger:
    include:
      - project: "cnp/bbpneo/02-ops/moqap" # dbds moqap project
        ref: "$CURRENT_VERSION" # branch
        file: "pipelines/trivy/trivy-scanimage.yaml"
    strategy: depend

Scan Gitlab Runner Image v17.2.1:
  stage: security-scan
  variables:
    TRIVY_TARGET: "docker-hub-remote.bahnhub.tech.rz.db.de/gitlab/gitlab-runner:alpine-v17.2.1"
  trigger:
    include:
      - project: "cnp/bbpneo/02-ops/moqap" # dbds moqap project
        ref: "$CURRENT_VERSION" # branch
        file: "pipelines/trivy/trivy-scanimage.yaml"
    strategy: depend
