include:
  - project: "moqap/modules"
    ref: "3.3.7"
    file:
      - "/artifactory/download_artifacts_dir.yml" #gibt es noch nicht in den includes muss in pipeline.yaml hinterlegt werden
  - "/pipelines/settings.yaml"

variables:
  ARTIFACT_NAME: $CI_PROJECT_NAME
  BASE_SERVICE_URL: $BASE_SERVICE_URL
  PROPERTY_FILE: "ci.properties"
  RUNNER_MOUNT_PATH: "/tmp/${PROJECT_NAME}/${PROJECT_NAME}-${STAGE_ENV}/${PROJECT_NAME}-secret-claim-runner-${STAGE_ENV}"
  BETRAANTRAG_USERNAME: ""
  BETRAANTRAG_PASSWORD: ""

.job_template: &job_template
  tags:
    - $PROJECT_RUNNER_TAG

Download Dependencies:
  extends: .Download-Artifacts
  stage: integrationtest
  <<: *job_template
  needs:
    - job: Deployment BizHub
  after_script:
    - mkdir -p ./artifacts/
    - cp download/cnp/dbds/bbpneo-3bds/testframework/master/int/artifacts/testframework-1.0-SNAPSHOT-all.jar  artifacts
  variables:
    ARTIFACTORY_PATH: "cna-3bservices-dev-docker-stage-local/cnp/dbds/bbpneo-3bds/testframework/master/int/artifacts/"
    TARGET_DIR: "download"
  artifacts:
    paths:
      - artifacts/*
  rules:
    - if: $BIZHUB_DISABLE != "true"
      when: always
    - if: $BIZHUB_DISABLE == "true"
      when: never


Download Secrets:
  stage: integrationtest
  <<: *job_template
  needs:
    - job: Deployment BizHub
  image: docker-hub-remote.bahnhub.tech.rz.db.de/openjdk:19-jdk-alpine3.16
  rules:
    - if: $CI_PROJECT_NAME == "betraprocess" && $BIZHUB_DISABLE != "true"
      when: always
  script:
    - getSecret() { awk -F\""$1"\":\" '{if (NF > 1 ) print $2; else exit 1;}' < "$2" | awk -F"\",\"|\"}" '{print $1}' || FAIL="$3\n-> $4" ; }
    - echo $RUNNER_MOUNT_PATH
    - export BETRAANTRAG_USERNAME=$(getSecret betraprocess_api_username $RUNNER_MOUNT_PATH $FAIL BETRAANTRAG_USERNAME)
    - export BETRAANTRAG_PASSWORD=$(getSecret betraprocess_api_password $RUNNER_MOUNT_PATH $FAIL BETRAANTRAG_PASSWORD)
    - export BETRAANTRAG_CLIENTSECRET=$(getSecret api_key $RUNNER_MOUNT_PATH $FAIL BETRAANTRAG_CLIENTSECRET)
    - export BETRAANTRAG_CLIENTID=$(getSecret client_id $RUNNER_MOUNT_PATH $FAIL BETRAANTRAG_CLIENTID)
    - echo $BETRAANTRAG_USERNAME = BETRAANTRAG_USERNAME


Integration Test:
  stage: integrationtest
  <<: *job_template
  image: docker-hub-remote.bahnhub.tech.rz.db.de/openjdk:19-jdk-alpine3.16
  needs:
    - job: Download Dependencies
      artifacts: true
    - job: Deployment BizHub
    - job: Download Secrets
      artifacts: true
  dependencies:
    - Download Dependencies
  script:
    - getSecret() { awk -F\""$1"\":\" '{if (NF > 1 ) print $2; else exit 1;}' < "$2" | awk -F"\",\"|\"}" '{print $1}' || FAIL="$3\n-> $4" ; }
    - echo $RUNNER_MOUNT_PATH
    - export BETRAANTRAG_USERNAME=$(getSecret betraprocess_api_username $RUNNER_MOUNT_PATH $FAIL BETRAANTRAG_USERNAME)
    - export BETRAANTRAG_PASSWORD=$(getSecret betraprocess_api_password $RUNNER_MOUNT_PATH $FAIL BETRAANTRAG_PASSWORD)
    - export BETRAANTRAG_CLIENTSECRET=$(getSecret api_key $RUNNER_MOUNT_PATH $FAIL BETRAANTRAG_CLIENTSECRET)
    - export BETRAANTRAG_CLIENTID=$(getSecret client_id $RUNNER_MOUNT_PATH $FAIL BETRAANTRAG_CLIENTID)
    - echo $BETRAANTRAG_USERNAME = BETRAANTRAG_USERNAME
    - java -DDEPLOY_ENV=${DEPLOY_ENV} -DARTIFACT_NAME=${ARTIFACT_NAME} -DBASEURL=${BASE_SERVICE_URL} -DUSER=${BETRAANTRAG_USERNAME} -DPASSWORD=${BETRAANTRAG_PASSWORD} -jar ./artifacts/testframework-1.0-SNAPSHOT-all.jar
  artifacts:
    when: always
    name: "Cucumber Report"
    paths:
      - cucumber.html
      - cucumber.xml
    reports:
       junit: cucumber.xml
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      when: always
    - if: $BIZHUB_DISABLE == "true"
      when: never

