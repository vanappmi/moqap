---
include:
  - project: "moqap/modules"
    ref: "5.0.0"
    file:
      - "/artifactory/download_artifacts_dir.yml" #gibt es noch nicht in den includes muss in pipeline.yaml hinterlegt werden
      - "/templates/moqap_templates.yml"
  - "/pipelines/settings.yaml"


variables:
  ARTIFACT_NAME: $CI_PROJECT_NAME
  BASE_SERVICE_URL: $BASE_SERVICE_URL
  PROPERTY_FILE: "ci.properties"
  RUNNER_MOUNT_PATH: "/tmp/${PROJECT_NAME}/${PROJECT_NAME}-${STAGE_ENV}/${PROJECT_NAME}-secret-claim-${STAGE_ENV}"
  JUNIT_REPORT_FILENAME: "results.octane.xml"

default:
  tags:
    - $PROJECT_RUNNER_TAG

Download Dependencies:
  extends: .Download-Artifacts
  stage: integrationtest
  rules:
    - if: ($CI_PROJECT_NAME == "betraprocess" || $CI_PROJECT_NAME == "tveservice") && $BIZHUB_DISABLE != "true" && $CI_COMMIT_BRANCH
      needs:
        - job: Deployment BizHub
      when: always
  after_script:
    - mkdir -p ./artifacts/
    - ls -lR download
    - cp download/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME/$DEPLOY_ENV/artifacts/testframework-1.0-SNAPSHOT-all.jar  artifacts
  variables:
    ARTIFACTORY_PATH: "${DEV_DOCKER_REPO}/cnp/dbds/bbpneo-3bds/testframework/master/int/artifacts/"
    TARGET_DIR: "download"
    SECRETS:
      ARTIFACTORY_USER:RUNNER_ARTIFACTORY_USER,
      ARTIFACTORY_PASSWORD:RUNNER_ARTIFACTORY_PASSWORD,
  artifacts:
    paths:
      - artifacts/*

Integration Test:
  stage: integrationtest
  image: docker-hub-remote.bahnhub.tech.rz.db.de/openjdk:19-jdk-alpine3.16
  variables:
    AWS_SM_SECRET_PATH: $RUNNER_MOUNT_PATH
  rules:
    - if: ($CI_PROJECT_NAME == "betraprocess" || $CI_PROJECT_NAME == "tveservice") && $BIZHUB_DISABLE != "true" && $CI_COMMIT_BRANCH
      needs:
        - job: Download Dependencies
          artifacts: true
        - job: Deployment BizHub
      when: always
  dependencies:
    - Download Dependencies
  script:
    - !reference [ .template secrets, script ]
    - cp ./artifacts/testframework-1.0-SNAPSHOT-all.jar .
    - java -jar testframework-1.0-SNAPSHOT-all.jar
  artifacts:
    when: always
    name: "Cucumber Report"
    paths:
      - cucumber.html
      - ${JUNIT_REPORT_FILENAME}
    reports:
      junit: ${JUNIT_REPORT_FILENAME}
