---
include:
  - project: "moqap/modules"
    ref: "11.3.0"
    file:
      - "/jmeter/jmeter.yml"
  - "pipelines/templates/bbpneo_templates.yml"
.lap-test:
  stage: run-lap-test
  variables:
    ES_INDEX: "jmeter-results-${CI_PROJECT_NAME}-${CI_COMMIT_SHORT_SHA}"
    ES_PORT: "80"
    ES_PROTOCOL: "https"
    MQP_JMETER_PLUGIN_PATH: "plugins/"
    ARTIFACTS_DIR: "artifacts"
  extends: .jmeter
  before_script:
    - !reference [ .template secrets, script ]
    - !reference [ .template jmeter-run, script ]
    - echo ${CI_PROJECT_NAME}
    - echo ${REPORT_URL}
    - echo ${API_PASSWORD}
  after_script:
    - pwd
    - echo ${API_USER}
    - echo ${API_PASSWORD}
    - echo ${REPORT_URL}
    - cd artifacts/jmeterreport
    - export payload=report.json
    - cp statistics.json $payload
    # remove test-case name
    - sed -i -e 's/"\w*\s*\w*"\s*:\s*{/{/g' $payload
    # replace first occurence of {
    - sed -i -e '1s/{/[/' $payload
    # replace last occurence of }
    - sed -i -i '$ s/}/]/' $payload
    - curl -X POST "$REPORT_URL/api/report?serviceName=$CI_PROJECT_NAME&jobId=$JOB_ID" H "accept:*/*" -H "Content-Type:application/json"  -u "lup-reportuser:$API_PASSWORD" -d @$payload
  artifacts:
    paths:
      - artifacts/*
  timeout: 24 hours