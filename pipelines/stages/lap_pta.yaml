---
include:
  - project: "moqap/modules"
    ref: "3.3.7"
    file:
      - "/jmeter/jmeter.yml"

.job_template: &job_template
  tags:
    - $PROJECT_RUNNER_TAG

LaP & PTA Test:
  extends: .jmeter
  stage: dynamic-test
  <<: *job_template
  needs:
    - job: Deployment BizHub
      optional: true
    - job: Deployment STAGE
  variables:
    CMMD_VAR: "-JbaseURL=${BASE_SERVICE_URL}"
    ES_INDEX: "jmeter-results-${CI_PROJECT_NAME}-${CI_COMMIT_SHORT_SHA}"
    ES_PORT: "80"
    ES_PROTOCOL: "https"
    TESTCASE_PATH: "test/lup/3BServices_LuP_Test.jmx"
    PLUGIN_PATH: "test/lup/plugins"
    ARTIFACTS_DIR: "artifacts"
  before_script:
    - getSecret() { awk -F\""$1"\":\" '{if (NF > 1 ) print $2; else exit 1;}' < "$2" | awk -F"\",\"|\"}" '{print $1}' || FAIL="$3\n-> $4" ; }
    - echo $RUNNER_MOUNT_PATH
    - export BETRAANTRAG_USERNAME=$(getSecret betraprocess_api_username $RUNNER_MOUNT_PATH $FAIL BETRAANTRAG_USERNAME)
    - export BETRAANTRAG_PASSWORD=$(getSecret betraprocess_api_password $RUNNER_MOUNT_PATH $FAIL BETRAANTRAG_PASSWORD)
    - export BASE_SERVICE_URL=$(echo $BASE_SERVICE_URL | cut -c 9-)
    - echo $BASE_SERVICE_URL
    - echo $BETRAANTRAG_USERNAME
    - export CMMD_VAR="-JbaseURL=${BASE_SERVICE_URL} -JapiUsername=${BETRAANTRAG_USERNAME} -JapiPasswort=${BETRAANTRAG_PASSWORD}"
    - mkdir -p ./artifacts/
    - sed -i -e "s/REPLACE_ELASTIC_INDEX/$ES_INDEX/g" $TESTCASE_PATH
    - sed -i -e "s/REPLACE_ELASTIC_HOST/$ES_HOST/g" $TESTCASE_PATH
    - sed -i -e "s/REPLACE_ELASTIC_PORT/$ES_PORT/g" $TESTCASE_PATH
    - sed -i -e "s/REPLACE_ELASTIC_PROTOCOL/$ES_PROTOCOL/g" $TESTCASE_PATH
  artifacts:
    paths:
      - artifacts/*
  rules:
    - if: $LAP_TEST_DISABLE != "true"
      when: always
    - if: $LAP_TEST_DISABLE == "true"
      when: never
  timeout: 3 hours
