---
include:
  - project: "moqap/modules"
    ref: "11.3.0"
    file:
      - "/jmeter/jmeter.yml"

.job_template: &job_template
  tags:
    - $PROJECT_RUNNER_TAG

LaP & PTA Test:
  extends: .jmeter
  stage: dynamic-test
  <<: *job_template
  needs:
    - job: Deployment BizHub
      optional: true
    - job: Deployment STAGE
  variables:
    CMMD_VAR: "-JbaseURL=${BASE_SERVICE_URL}"
    ES_INDEX: "jmeter-results-${CI_PROJECT_NAME}-${CI_COMMIT_SHORT_SHA}"
    ES_PORT: "80"
    ES_PROTOCOL: "https"
    MQP_JMETER_TESTCASE_PATH: "test/lup/3BServices_LuP_Test.jmx"
    MQP_JMETER_PLUGIN_PATH: "test/lup/plugins"
    ARTIFACTS_DIR: "artifacts"
    SECRETS:
      BETRAANTRAG_USERNAME:betraprocess_api_username,
      BETRAANTRAG_PASSWORD:betraprocess_api_password
  before_script:
    - !reference [ .template secrets, script ]
    - export BASE_SERVICE_URL=$(echo $BASE_SERVICE_URL | cut -c 9-)
    - echo $BASE_SERVICE_URL
    - echo $BETRAANTRAG_USERNAME
    - export CMMD_VAR="-JbaseURL=${BASE_SERVICE_URL} -JapiUsername=${BETRAANTRAG_USERNAME} -JapiPasswort=${BETRAANTRAG_PASSWORD}"
    - mkdir -p ./artifacts/
    - sed -i -e "s/REPLACE_ELASTIC_INDEX/$ES_INDEX/g" $MQP_JMETER_TESTCASE_PATH
    - sed -i -e "s/REPLACE_ELASTIC_HOST/$ES_HOST/g" $MQP_JMETER_TESTCASE_PATH
    - sed -i -e "s/REPLACE_ELASTIC_PORT/$ES_PORT/g" $MQP_JMETER_TESTCASE_PATH
    - sed -i -e "s/REPLACE_ELASTIC_PROTOCOL/$ES_PROTOCOL/g" $MQP_JMETER_TESTCASE_PATH
  artifacts:
    paths:
      - artifacts/*
  # rules dev vs. int
  except:
    variables:
      - $LAP_TEST_DISABLE == "true"
  timeout: 4 hours
