---
include:
  - project: "moqap/modules"
    ref: "3.3.7"
#    ref: "10.0.0"
    file: "/business-hub/api-portal/api-only-v3.yml"
  - project: "moqap/modules"
    ref: "10.0.0"
    file:
      - "/templates/moqap_templates.yml"

variables:
  STAGE_ENV: "dev"
  API_ONLY_V3_USE_NEW_AUTH: "true"
  DEBUG_API_ONLY_V3_CONNECT_CONFIG: "true"
  FIELD_DEPLOYER_APP_CLIENT_ID: "client-key"
  FIELD_DEPLOYER_APP_CLIENT_SECRET: "api-key"
  FIELD_SERVICE_USER: "service-user"
  FIELD_SERVICE_PASSWORD: "service-password"
  CONNECT_CONFIG: $BIZHUB_CONNECT_CONFIG
  DEPLOY_ENV: ""
  SOPS: "false"
  SECRETS:
    SERVICE_USER:$FIELD_SERVICE_USER,
    SERVICE_PASSWORD:$FIELD_SERVICE_PASSWORD,
    SPACE_NAME:RUNNER_BIZHUB_SPACE_NAME,
    FIELD_DEPLOYER_APP_CLIENT_ID:bbr_bizhub_api_client,
    FIELD_DEPLOYER_APP_CLIENT_SECRET:bbr_bizhub_api_key

workflow:
  rules:
    - when: always

bizhub_base:
  before_script:
    - !reference [ .template secrets, script ]
    - echo "DEPLOY_ENV=$DEPLOY_ENV"
    - export BIZHUB_DEPLOYER_APP_CLIENT_ID="$FIELD_DEPLOYER_APP_CLIENT_ID"
    - export BIZHUB_DEPLOYER_APP_CLIENT_SECRET="$FIELD_DEPLOYER_APP_CLIENT_SECRET"
    - echo "SERVICE_USER=$SERVICE_USER"
    - echo "AWS_SM_SECRET_PATH=$AWS_SM_SECRET_PATH"
    - echo $CONNECT_CONFIG
    - echo "FIELD_DEPLOYER_APP_CLIENT_ID=$FIELD_DEPLOYER_APP_CLIENT_ID"
    - echo "FIELD_DEPLOYER_APP_CLIENT_SECRET=$FIELD_DEPLOYER_APP_CLIENT_SECRET"
    - echo "SPACE_NAME=$SPACE_NAME"
    - |
      if [ $DEPLOY_ENV == "au" ] || [ $DEPLOY_ENV == "lup" ] || [ $DEPLOY_ENV == "prod" ];
      then
        CURRENT_VERSION=$(cat pipelines/$DEPLOY_ENV/bizhub/product.yaml | grep "version" | cut -d ":" -f2 | tr -dc '0-9.' | tr '.' '-' )
        export CI_COMMIT_REF_SLUG=release-$CURRENT_VERSION
      fi
    - echo $CI_COMMIT_REF_SLUG
    - |
      if [ $DEPLOY_ENV == "lup" ];
      then
        export STAGE=lup
      fi
    - echo $STAGE
  script:
    - echo "bizhub_base"
  rules:
    - if: $DEPLOY_ENV
      when: never
  stage: .pre

lint_connect_config:
  before_script:
    - !reference [bizhub_base, before_script]
  tags:
    - $PROJECT_RUNNER_TAG

publish_product_apic_review:
  before_script:
    - !reference [bizhub_base, before_script]
  rules:
    - if: $DEPLOY_ENV == "dev"
  tags:
    - $PROJECT_RUNNER_TAG

publish_product_apic_manual_test:
  before_script:
    - !reference [bizhub_base, before_script]
  rules:
    - if: $DEPLOY_ENV == "int"
  tags:
    - $PROJECT_RUNNER_TAG

publish_product_apic_automatic_test:
  before_script:
    - !reference [bizhub_base, before_script]
  rules:
    - if: ($DEPLOY_ENV == "au" || $DEPLOY_ENV == "lup")
  tags:
    - $PROJECT_RUNNER_TAG

publish_product_apic_production:
  before_script:
    - !reference [bizhub_base, before_script]
  rules:
    - if: $DEPLOY_ENV == "prod"
  tags:
    - $PROJECT_RUNNER_TAG

drop_product_apic_review:
  rules:
    - if: $DEPLOY_ENV == "dev"
      when: manual
  tags:
    - $PROJECT_RUNNER_TAG

drop_product_apic_manual_test:
  rules:
    - if: $DEPLOY_ENV == "int"
      when: manual
  tags:
    - $PROJECT_RUNNER_TAG

drop_product_apic_automatic_test:
  rules:
    - if: ($DEPLOY_ENV == "au" || $DEPLOY_ENV == "lup")
      when: manual
  tags:
    - $PROJECT_RUNNER_TAG
