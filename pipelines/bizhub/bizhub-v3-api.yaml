---
include:
  - project: "moqap/modules"
    ref: "3.3.6"
    file: "/business-hub/api-portal/api-only-v3.yml"

variables:
  STAGE_ENV: "dev"
  RUNNER_MOUNT_PATH: "/tmp/${PROJECT_NAME}/${PROJECT_NAME}-${STAGE_ENV}/${PROJECT_NAME}-secret-claim-runner-${STAGE_ENV}"
  API_ONLY_V3_USE_NEW_AUTH: "true"
  DEBUG_API_ONLY_V3_CONNECT_CONFIG: "true"
  AWS_SM_SECRET_PATH: "$RUNNER_MOUNT_PATH"
  FIELD_DEPLOYER_APP_CLIENT_ID: "client-key"
  FIELD_DEPLOYER_APP_CLIENT_SECRET: "api-key"
  #  FIELD_SERVICE_USER: "service-user"
  #  FIELD_SERVICE_PASSWORD: "service-password"
  CONNECT_CONFIG: $BIZHUB_CONNECT_CONFIG
  DEPLOY_ENV: ""

workflow:
  rules:
    - when: always

bizhub_base:
  before_script:
    - getSecret() { awk -F\""$1"\":\" '{if (NF > 1 ) print $2; else exit 1;}' < "$2" | awk -F"\",\"|\"}" '{print $1}' || FAIL="$3\n-> $4" ; }
    - echo "DEPLOY_ENV=$DEPLOY_ENV"
    #    - export SERVICE_USER=$(getSecret $FIELD_SERVICE_USER $RUNNER_MOUNT_PATH $FAIL SERVICE_USER)
    #    - export SERVICE_PASSWORD=$(getSecret $FIELD_SERVICE_PASSWORD $RUNNER_MOUNT_PATH $FAIL SERVICE_PASSWORD)
    #    - echo "SERVICE_USER=$SERVICE_USER"
    - echo "AWS_SM_SECRET_PATH=$AWS_SM_SECRET_PATH"
    - echo $CONNECT_CONFIG
    - echo "FIELD_DEPLOYER_APP_CLIENT_ID=$FIELD_DEPLOYER_APP_CLIENT_ID"
    - echo "FIELD_DEPLOYER_APP_CLIENT_SECRET=$FIELD_DEPLOYER_APP_CLIENT_SECRET"
  script:
    - echo "bizhub_base"
  rules:
    - if: $DEPLOY_ENV
      when: never
  stage: .pre

lint_connect_config:
  before_script:
    - !reference [bizhub_base, before_script]
  tags:
    - $PROJECT_RUNNER_TAG

publish_product_apic_review:
  before_script:
    - !reference [bizhub_base, before_script]
  rules:
    - if: $DEPLOY_ENV == "dev"
  tags:
    - $PROJECT_RUNNER_TAG

publish_product_apic_manual_test:
  before_script:
    - !reference [bizhub_base, before_script]
  rules:
    - if: $DEPLOY_ENV == "int"
  tags:
    - $PROJECT_RUNNER_TAG

publish_product_apic_automatic_test:
  before_script:
    - !reference [bizhub_base, before_script]
  rules:
    - if: $DEPLOY_ENV == "au"
  tags:
    - $PROJECT_RUNNER_TAG
#
#publish_product_apic_lup:
#  before_script:
#    - !reference [bizhub_base, before_script]
#  rules:
#    - if: $DEPLOY_ENV == "lup"
#  tags:
#    - $PROJECT_RUNNER_TAG


publish_product_apic_production:
  before_script:
    - !reference [bizhub_base, before_script]
  rules:
    - if: $DEPLOY_ENV == "prod"
  tags:
    - $PROJECT_RUNNER_TAG

drop_product_apic_review:
  rules:
    - if: $DEPLOY_ENV == "dev"
      when: manual
  tags:
    - $PROJECT_RUNNER_TAG

drop_product_apic_manual_test:
  rules:
    - if: $DEPLOY_ENV == "int"
      when: manual
  tags:
    - $PROJECT_RUNNER_TAG

drop_product_apic_automatic_test:
  rules:
    - if: $DEPLOY_ENV == "au"
      when: manual
  tags:
    - $PROJECT_RUNNER_TAG
